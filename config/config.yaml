# FFmpeg Autoencoder Configuration

# Application Settings
app:
  temp_dir: "/tmp"
  stats_prefix: "ffmpeg_stats"
  
# External Tool Paths
tools:
  ffmpeg: "ffmpeg"
  ffprobe: "ffprobe"
  nnedi_weights: "/home/christian/Documents/source/ffmpeg_autoencoder/neural/nnedi3_weights.bin"
  dovi_tool:    
    path: "/usr/bin/dovi_tool"        # Path to dovi_tool binary
    timeout_seconds: 300              # Tool operation timeout (5 minutes)
  hdr10plus_tool:              
    path: "/usr/bin/hdr10plus_tool"   # Path to hdr10plus_tool binary
    timeout_seconds: 300              # Tool operation timeout (5 minutes)
    # extract_args: ["--verbose"]     # Optional custom extraction arguments
    # inject_args: ["--force"]        # Optional custom injection arguments

# Logging Configuration
logging:
  level: "info"  # trace, debug, info, warn, error
  show_timestamps: true
  colored_output: true

# Progress Tracking
progress:
  update_interval_ms: 1000

# Analysis Settings
analysis:
  crop_detection:
    enabled: true
    sample_count: 3 # Number of evenly distributed sample points across video duration 
    sdr_crop_limit: 24 # Crop detection threshold for SDR content
    hdr_crop_limit: 64 # Crop detection threshold for HDR content  
    min_pixel_change_percent: 2.0  # Only apply crops that remove >n% of pixels
  
  hdr_detection:
    enabled: true
    color_space_patterns:
      - "bt2020"
      - "rec2020"
    transfer_patterns:
      - "smpte2084"
      - "arib-std-b67"
    crf_adjustment: 1.0 
    # See paper https://openaccess.thecvf.com/content/CVPR2024/papers/
    # Cao_Perceptual_Assessment_and_Optimization_of_HDR_Image_Rendering_C
    # VPR_2024_paper.pdf  

  dolby_vision:
    enabled: true                     # Enable Dolby Vision processing
    preserve_profile_7: true          # Convert Profile 7 to 8.1
    target_profile: "8.1"             # Default target profile (8.1 or 8.2)
    require_dovi_tool: false          # Fail if dovi_tool missing (graceful fallback)
    temp_dir: "/tmp"                  # RPU temporary storage location
    auto_profile_conversion: true     # Auto convert profiles for compatibility
    fallback_to_hdr10: true          # Fallback to HDR10 if DV processing fails
    crf_adjustment: 1.0               # Lower than HDR10's +2.0 (DV needs conservative encoding)
    bitrate_multiplier: 1.8           # Higher than HDR10's 1.3x (DV requires more bitrate)
    vbv_bufsize: 160000               # Mandatory VBV buffer size for Level 5.1 High Tier
    vbv_maxrate: 160000               # Mandatory VBV max rate (required for DV compliance)
    profile_specific_adjustments: true # Different settings per DV profile

  hdr10_plus:
    enabled: true                     # Enable HDR10+ dynamic metadata processing
    require_tool: false               # Graceful fallback if hdr10plus_tool missing
    fallback_to_hdr10: true          # Fallback to HDR10 if HDR10+ processing fails
    temp_dir: "/tmp"                  # Temporary directory for metadata files
    validate_curves: true             # Validate tone mapping curves
    crf_adjustment: 2.5               # Higher than HDR10's +2.0 (complexity of dynamic metadata)
    bitrate_multiplier: 1.4           # 40% bitrate increase for dynamic metadata preservation
    encoding_complexity: 1.4          # Processing complexity multiplier
    # max_scenes: 100                 # Optional maximum scenes for Samsung compatibility    

# Video Filter Settings
filters:
  deinterlace:
    primary_method: "nnedi"
    fallback_method: "yadif"
    nnedi_settings:
      field: "af"
  
  denoise:
    filter: "hqdn3d"
    params: "1:1:2:2"

# Encoding Profiles
profiles:
  movie:
    title: "Standard Movie"
    base_crf: 22
    base_bitrate: 10000
    hdr_bitrate: 13000
    content_type: "film"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      no-sao: true
      bframes: 5
      b-adapt: 2
      ref: 4
      psy-rd: 1.5
      psy-rdoq: 2.0
      aq-mode: 2
      aq-strength: 0.9
      deblock: "-1,-1"
      rc-lookahead: 40
      merange: 57
      max-tu-size: 32
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.70
      weightb: true
      weightp: true
      cutree: true
      me: "hex"
      subme: 3

  movie_mid_grain:
    title: "Movies with lighter grain"
    base_crf: 21
    base_bitrate: 11000
    hdr_bitrate: 14000
    content_type: "film"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      no-sao: true
      bframes: 5
      b-adapt: 2
      ref: 4
      psy-rd: 2.0
      psy-rdoq: 2.5
      aq-mode: 2
      aq-strength: 0.8
      deblock: "-2,-2"
      rc-lookahead: 40
      merange: 57
      max-tu-size: 32
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.65
      weightb: true
      weightp: true
      cutree: true
      me: "hex"
      subme: 4
      rskip: 2
      rskip-edge-threshold: 2
      rect: true
      strong-intra-smoothing: false

  movie_size_focused:
    title: "Standard Movie (smaller size)"
    base_crf: 22
    base_bitrate: 10000
    hdr_bitrate: 13000
    content_type: "film"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      rc-lookahead: 80
      aq-mode: 2
      repeat-headers: false
      strong-intra-smoothing: true
      bframes: 4
      b-adapt: 2
      frame-threads: 0
      qcomp: 0.60
      me: "hex"
      subme: 4

  heavy_grain:
    title: "4K heavy grain (consider using --denoise)"
    base_crf: 21
    base_bitrate: 12000
    hdr_bitrate: 15000
    content_type: "heavy_grain"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      selective-sao: 2
      deblock: "-1,-1"
      aq-mode: 3
      psy-rd: 0.8
      psy-rdoq: 1.0
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 5
      b-adapt: 2
      ref: 6
      rc-lookahead: 60
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 7
      merange: 57

  "3d_cgi":
    title: "3D CGI (Pixar-like)"
    base_crf: 22
    base_bitrate: 10000
    hdr_bitrate: 13000
    content_type: "3d_animation"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      limit-sao: 1
      deblock: "1,1"
      aq-mode: 3
      aq-strength: 0.9
      psy-rd: 1.6
      psy-rdoq: 1.5
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 5
      b-adapt: 2
      ref: 5
      rc-lookahead: 60
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      weightb: true
      weightp: true
      cutree: true
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 7
      merange: 57

  "3d_complex":
    title: "3D complex content (Arcane-like)"
    base_crf: 22
    base_bitrate: 11000
    hdr_bitrate: 14000
    content_type: "3d_animation"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      no-sao: true
      deblock: "1,1"
      aq-mode: 3
      aq-strength: 1.0
      psy-rd: 2.0
      psy-rdoq: 2.5
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 6
      b-adapt: 2
      ref: 6
      rc-lookahead: 80
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      weightb: true
      weightp: true
      cutree: true
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 6
      merange: 57

  anime:
    title: "Anime"
    base_crf: 23
    base_bitrate: 9000
    hdr_bitrate: 12000
    content_type: "anime"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      limit-sao: 1
      deblock: "1,1"
      aq-mode: 3
      aq-strength: 0.8
      psy-rd: 1.1
      psy-rdoq: 1.0
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 4
      b-adapt: 2
      ref: 6
      rc-lookahead: 60
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 6
      merange: 57

  classic_anime:
    title: "Classic 90s Anime with finer details"
    base_crf: 22
    base_bitrate: 10000
    hdr_bitrate: 12000
    content_type: "classic_anime"
    x265_params:
      preset: "slow"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      limit-sao: 1
      deblock: "0,0"
      aq-mode: 3
      aq-strength: 0.8
      psy-rd: 0.9
      psy-rdoq: 1.0
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 5
      b-adapt: 2
      ref: 6
      rc-lookahead: 80
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 5
      merange: 57

  "4k":
    title: "General 4K balanced optimization"
    base_crf: 22
    base_bitrate: 15000
    hdr_bitrate: 20000
    content_type: "mixed"
    x265_params:
      preset: "medium"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      no-sao: true
      bframes: 4
      b-adapt: 2
      ref: 4
      psy-rd: 1.2
      psy-rdoq: 1.8
      aq-mode: 2
      aq-strength: 0.9
      deblock: "-1,-1"
      rc-lookahead: 40
      merange: 57
      max-tu-size: 32
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.65
      weightb: true
      weightp: true
      cutree: true
      me: "hex"
      subme: 4

  "4k_heavy_grain":
    title: "4K heavy grain preservation with selective SAO"
    base_crf: 21
    base_bitrate: 18000
    hdr_bitrate: 24000
    content_type: "heavy_grain"
    x265_params:
      preset: "medium"
      pix_fmt: "yuv420p10le"
      profile: "main10"
      selective-sao: 2
      deblock: "-1,-1"
      aq-mode: 3
      aq-strength: 1.0
      psy-rd: 0.8
      psy-rdoq: 1.0
      rskip: 2
      rskip-edge-threshold: 2
      bframes: 5
      b-adapt: 2
      ref: 6
      rc-lookahead: 60
      ctu: 64
      rd: 4
      rdoq-level: 2
      qcomp: 0.75
      keyint: 240
      min-keyint: 24
      me: "hex"
      subme: 7
      merange: 57
